<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/global.css">
</head>

<body onload="exibirSetores(), validarSessao()">
  <div class="alhinhamento">
    <div class="menu">
      <img src="assets/img/profile.png" >
      <strong>Olá,<strong id="b_usuario">usuário</strong>!</strong>
      <ul>
        <li>
          <a href="/site.html"><img src="assets/img/silhueta-de-icone-de-casa.png" >Home</a>
        </li>
        <li>
          <a href="mailto:becold@email.com"><img src="assets/img/suporte-ao-cliente.png" >Suporte</a>
        </li>
        <li>
          <a href="/site.html"><img src="assets/img/sair.png" onclick="limparSessao()">Sair</a>
        </li>
      </ul>
    </div>

    <div class="dashboard">
      <h1>Selecione o setor que deseja visualizar</h1>
      <div class="alinhamento-custom">
        <select id="slct_setor" oninput="">
        </select>
        <button onclick="cadastrarSetor()"><img src="assets/img/more.png"></button>
      </div>
    <div class="linha-alhinhamento">
      <div class="KPI">
        <h5> Média de Umidade mais alta nas últimas 4 horas </h5>
        <h3> Sensor 3 - 59% <img src="assets/img/umidade.png"></h3>
      </div>
      <div class="KPI">
        <h5>Média de Umidade mais baixa nas últimas 4 horas</h5>
        <h3> Sensor 1 - 40% <img src="assets/img/umidade.png"></h3>
      </div>
      <div class="KPI">
        <h5>Média de Temperatura mais alta nas últimas 4 horas</h5>
        <h3> Sensor 12 -  28ºC <img src="assets/img/temperatura.png"></h3>
      </div>
      <div class="KPI">
        <h5>Média de Temperatura mais baixa nas últimas 4 horas</h5>
        <h3> Sensor 5 -  17ºC <img src="assets/img/temperatura.png"></h3>
      </div>
    </div>
    <div class="linha-alhinhamento">
      <div class="card-metrica">
        <h2>Métrica</h2>
        <div class="card-background">
          <div id="div_critico+" style="background-color: red;" class="metrica"><span>Critico</span></div>
          <div id="div_emergencia+" style="background-color: orange;" class="metrica"><span>Emergência</span></div>
          <div id="div_alerta+" style="background-color: rgb(252, 252, 28);" class="metrica"><span>Alerta</span></div>
          <div id="div_ideal" style="background-color: green;" class="metrica"><span>Ideal</span></div>
          <div id="div_alerta-" style="background-color: rgb(252, 252, 28);" class="metrica"><span>Alerta</span></div>
          <div id="div_emergencia-" style="background-color: orange;" class="metrica"><span>Emergência</span></div>
          <div id="div_critico-" style="background-color: red;" class="metrica"><span>Critico</span></div>
        </div>
      </div>
    </div>
    <div class="linha-alhinhamento">
      <div id="graficos"></div>
    </div>
  </div>
</body>

<script>
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  let proximaAtualizacao;

  function exibirSetores() {
        JSON.parse(sessionStorage.SETORES).forEach(item => {
            document.getElementById("slct_setor").innerHTML += `
            <option value="${item.idSetor}">${item.nomeSetor}</option>
            `
        });
  }

  function exibirGraficoDoUsuario() {
        var setores = JSON.parse(sessionStorage.SETORES);
        setores.forEach(item => {
            document.getElementById("graficos").innerHTML += `
                <div id="grafico${item.idSetor}" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloAquario${item.idSetor}">${item.nomeSetor}</span>
                    </h3>
                    <div class="graph">
                        <canvas id="myChartCanvas${item.idSetor}"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura${item.idSetor}" style="color: white"></p>
                    </div>
                </div>
            `

            obterDadosGrafico(item.idSetor)
        })};

  function obterDadosGrafico(idSetor) {
      if (proximaAtualizacao != undefined) {
          clearTimeout(proximaAtualizacao);
      }

      fetch(`/medidas/ultimas/${idSetor}`, { cache: 'no-store' }).then(function (response) {
          if (response.ok) {
              response.json().then(function (resposta) {
                  console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                  resposta.reverse();

                  plotarGrafico(resposta, idSetor);

              });
          } else {
              console.error('Nenhum dado encontrado ou erro na API');
          }
      })
          .catch(function (error) {
              console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
          });
    }

    function plotarGrafico(resposta, idSetor) {

  console.log('iniciando plotagem do gráfico...');

  // Criando estrutura para plotar gráfico - labels
  let labels = [];

  // Criando estrutura para plotar gráfico - dados
  let dados = {
      labels: labels,
      datasets: [{
          label: 'Umidade',
          data: [],
          fill: false,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1
      },
      {
          label: 'Temperatura',
          data: [],
          fill: false,
          borderColor: 'rgb(199, 52, 52)',
          tension: 0.1
      }]
  };

  console.log('----------------------------------------------')
  console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
  console.log(resposta)

  // Inserindo valores recebidos em estrutura para plotar o gráfico
  for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      labels.push(registro.momento_grafico);
      dados.datasets[0].data.push(registro.umidade);
      dados.datasets[1].data.push(registro.temperatura);
  }

  console.log('----------------------------------------------')
  console.log('O gráfico será plotado com os respectivos valores:')
  console.log('Labels:')
  console.log(labels)
  console.log('Dados:')
  console.log(dados.datasets)
  console.log('----------------------------------------------')

  // Criando estrutura para plotar gráfico - config
  const config = {
      type: 'line',
      data: dados,
  };

  // Adicionando gráfico criado em div na tela
  let myChart = new Chart(
      document.getElementById(`myChartCanvas${idSetor}`),
      config
  );

  setTimeout(() => atualizarGrafico(idSetor, dados, myChart), 2000);
}

function atualizarGrafico(idSetor, dados, myChart) {
fetch(`/medidas/tempo-real/${idSetor}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (novoRegistro) {

            obterdados(idSetor);
            // alertar(novoRegistro, idAquario);
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(dados);

            // let avisoCaptura = document.getElementById(`avisoCaptura${idSetor}`)
            // avisoCaptura.innerHTML = ""


            if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                console.log("---------------------------------------------------------------")
                console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                console.log("Horário do novo dado capturado:")
                console.log(novoRegistro[0].momento_grafico)
                console.log("Horário do último dado capturado:")
                console.log(dados.labels[dados.labels.length - 1])
                console.log("---------------------------------------------------------------")
            } else {
                // tirando e colocando valores no gráfico
                dados.labels.shift(); // apagar o primeiro
                dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                myChart.update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idSetor, dados, myChart), 2000);
        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idSetor, dados, myChart), 2000);
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

}
















  // const é uma forma de declarar váriaveis, é uma constante, a primeira vez que ela é declarada, ela morrre desse jeito
  // const ctx = document.getElementById('umiChart');

  // new Chart(ctx, {
  //   type: 'line',
  //   data: {
  //     labels: ['12h', '12h30', '13h', '13h30', '14h', '14h30', '15h', '15h30', '16h'],
  //     datasets: [{
  //       label: 'Sensor 1',
  //       data: [40, 42, 48, 51, 55, 60, 59, 57, 52],
  //       borderColor: 'rgb(252, 252, 28)',
  //       backgroundColor: 'rgb(252, 252, 28)',
  //       borderWidth: 2
  //     }, {
  //       label: 'Sensor 2',
  //       data: [50, 48, 45, 46, 49, 50, 55, 56, 57],
  //       borderColor: 'rgb(252, 252, 28)',
  //       backgroundColor: 'rgb(252, 252, 28)',
  //       borderWidth: 2
  //     },
  //     {
  //       label: 'Sensor 3',
  //       data: [60, 62, 64, 61, 59, 57, 55, 52, 41],
  //       borderColor: 'green',
  //       backgroundColor: 'green',
  //       borderWidth: 2
  //     }, {
  //       label: 'Sensor 4',
  //       data: [41, 44, 43, 47, 48, 49, 51, 54, 45],
  //       borderColor: 'green',
  //       backgroundColor: 'green',
  //       borderWidth: 2
  //     }

  //     ]
  //   },
  //   options: {
  //     scales: {
  //       y: {
  //         beginAtZero: true
  //       }
  //     }
  //   }
  // })

  // const ctx1 = document.getElementById('tempChart');

  // new Chart(ctx1, {
  //   type: 'line',
  //   data: {
  //     labels: ['12h', '12h30', '13h', '13h30', '14h', '14h30', '15h', '15h30', '16h'],
  //     datasets: [{
  //       label: 'Sensor 1',
  //       data: [40, 42, 48, 51, 55, 60, 59, 57, 52],
  //       borderColor: 'red',
  //       backgroundColor: 'red',
  //       borderWidth: 2
  //     }, {
  //       label: 'Sensor 2',
  //       data: [50, 48, 45, 46, 49, 50, 55, 56, 31],
  //       borderColor: 'orange',
  //       backgroundColor: 'orange',
  //       borderWidth: 2
  //     },
  //     {
  //       label: 'Sensor 3',
  //       data: [60, 62, 64, 61, 59, 57, 55, 52, 41],
  //       borderColor: 'green',
  //       backgroundColor: 'green',
  //       borderWidth: 2
  //     }, {
  //       label: 'Sensor 4',
  //       data: [41, 44, 43, 47, 48, 49, 51, 54, 45],
  //       borderColor: 'green',
  //       backgroundColor: 'green',
  //       borderWidth: 2
  //     }

  //     ]
  //   },
  //   options: {
  //     scales: {
  //       y: {
  //         beginAtZero: true
  //       }
  //     }
  //   }
  // })

  
</script>
</html>