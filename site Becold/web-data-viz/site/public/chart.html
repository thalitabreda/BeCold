<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="cadastro.html">
  <link rel="stylesheet" href="css/estilo copy.css" />
  <link rel="stylesheet" href="css/cadastro copy.css">
  <link rel="stylesheet" href="css/global.css">
  <script src="../js/sessao.js"></script>
  <script src="../js/alerta.js"></script>

</head>

<body onload="exibirSetores(), validarSessao()">
  <div class="alhinhamento">
    <div class="menu">
      <img src="assets/img/profile.png">
      <strong>Olá, <strong id="b_usuario">usuário</strong> !</strong>
      <ul>
        <li>
          <a href="index.html"><img src="assets/img/silhueta-de-icone-de-casa.png">Home</a>
        </li>
        <li>
          <a href="mailto:becold@email.com"><img src="assets/img/suporte-ao-cliente.png">Suporte</a>
        </li>
        <li>
          <a href="index.html"><img src="assets/img/sair.png" onclick="limparSessao()">Sair</a>
        </li>
      </ul>
    </div>
    <div id="cadastrometricas" style="display: none; height: 450px; " class="margin cadastro-container">
      <div class="cadastro-input">
        <div class="input-esquerdo">
          <div>
            <h3>Informe os Parametros:</h3>
            <p>Nome do Setor<span style="color: red;">*</span></p>
            <div id="div_input_nomeSetor" class="div-input">
              <input class="inputs" type="text" id="input_setor">
              <div id="divNomeSetor" style="color: red;"></div>
            </div>
          </div>
          <div>
            <p>Intervalo Ideal da Temperatura</p>
            <div>
              <p>Min:<span style="color: red;">*</span></p>
              <div id="div_input_tempmin">
                <input class="inputs" type="number" id="input_tempMin">
                <div id="div_temperaturaErroMin" style="color: red;"></div>
              </div>
            </div>
            <div>
              <p>Máx:<span style="color: red;">*</span></p>
              <div id="div_input_tempmax">
                <input class="inputs" type="number" id="input_tempMax">
                <div id="div_temperaturaErroMax" style="color: red;"></div>
              </div>
            </div>
            <p>Intervalo Ideal da Umidade<span style="color: red;">*</span></p>
            <div>
              <p>Min:<span style="color: red;">*</span></p>
              <div id="div_input_umidademin">
                <input class="inputs" type="number" id="input_umidMin">
                <div id="div_umidadeErroMin" style="color: red;"></div>
              </div>
            </div>
            <div>
              <p>Máx:<span style="color: red;">*</span></p>
              <div id="div_input_umidademax">
                <input class="inputs" type="number" id="input_umidMax">
                <div id="div_umidadeErroMax" style="color: red;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="div-botao">
        <button class="cadastro-botao" onclick="exibircadastrometricas()">Cadastre</button>
      </div>
    </div>
    <div id="dashboad" class="dashboard">
      <h1>Selecione o setor que deseja visualizar</h1>
      <div class="alinhamento-custom">
        <select id="slct_setor">
        </select>
        <button onclick="exibircadastrometricas()"><img style="padding: 0px;" src="assets/img/more.png"></button>
      </div>
      <div class="linha-alhinhamento">
        <div class="KPI">
          <h5> Média de Umidade mais alta nas últimas 4 horas </h5>
          <h3> Sensor 3 - 59% <img src="assets/img/umidade.png"></h3>
        </div>
        <div class="KPI">
          <h5>Média de Umidade mais baixa nas últimas 4 horas</h5>
          <h3> Sensor 1 - 40% <img src="assets/img/umidade.png"></h3>
        </div>
        <div class="KPI">
          <h5>Média de Temperatura mais alta nas últimas 4 horas</h5>
          <h3> Sensor 12 - 28ºC <img src="assets/img/temperatura.png"></h3>
        </div>
        <div class="KPI">
          <h5>Média de Temperatura mais baixa nas últimas 4 horas</h5>
          <h3> Sensor 5 - 17ºC <img src="assets/img/temperatura.png"></h3>
        </div>
      </div>
      <div class="linha-alhinhamento">
        <div class="card-metrica">
          <h2>Métrica</h2>
          <div class="card-background">
            <div style="background-color: red;" class="metrica"><span>Critico</span><span>20% - 24%</span><span>5ºC -
                14ºC</span></div>
            <div style="background-color: orange;" class="metrica"><span>Emergência</span><span>25% -
                29%</span><span>15ºC - 16ºC</span></div>
            <div style="background-color: rgb(252, 252, 28);" class="metrica"><span>Alerta</span><span>30% - 39%
              </span><span>17ºC - 19ºC</span></div>
            <div style="background-color: green;" class="metrica"><span>Ideal</span><span>40% - 55%</span><span>20ºC -
                27ºC</span></div>
            <div style="background-color: rgb(252, 252, 28);" class="metrica"><span>Alerta</span><span>56% -
                65%</span><span>28ºC - 30ºC</span></div>
            <div style="background-color: orange;" class="metrica"><span>Emergência</span><span>66% -
                75%</span><span>31ºC - 35ºC</span></div>
            <div style="background-color: red;" class="metrica"><span>Critico</span><span>76% - 80%</span><span>36ºC -
                50ºC</span></div>
          </div>
        </div>
      </div>
      <div class="linha-alhinhamento">
        <div class="card-grafico">
          <h2>Umidade</h2>
          <canvas id="umiChart" style="position: relative;height:40vh;"></canvas>
        </div>
        <div class="card-grafico">
          <h2>Temperatura</h2>
          <canvas id="tempChart" style="position: relative;  height: 40vh;"></canvas>
        </div>
      </div>
</body>

<script>
  b_usuario.innerHTML = sessionStorage.EMPRESA_USUARIO

  function exibirSetores() {
    JSON.parse(sessionStorage.SETORES).forEach(item => {
      document.getElementById("slct_setor").innerHTML += `
            <option value="${item.idSetor}">${item.nomeSetor}</option>
            `

    });
  }


  function exibircadastrometricas() {


    dashboad.style.display = "none"
    cadastrometricas.style.display = "block"

    var empresa = sessionStorage.EMPRESA_USUARIO;
    var cnpj = sessionStorage.CNPJ_USUARIO;
    var email = sessionStorage.EMAIL_USUARIO;
    var NomeSetor = input_setor.value;
    var TempMin = Number(input_tempMin.value);
    var TempMax = Number(input_tempMax.value);
    var UmidadeMin = Number(input_umidMin.value);
    var UmidadeMax = Number(input_umidMax.value);

    if (NomeSetor == "" || TempMin == "" || TempMax == "" || UmidadeMin == "" || UmidadeMax == "" || TempMin >= TempMax | UmidadeMin >= UmidadeMax) {
      div_umidadeErroMax.innerHTML = `Cheque todas as entradas`;
    } else {

      fetch("/usuarios/buscarfk", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          empresaServer: empresa,
          cnpjServer: cnpj,
          emailServer: email,
          

        })
      }).then(function (resposta) {
        console.log("ESTOU NO THEN DO entrar()!")

        if (resposta.ok) {
          console.log(resposta);

          resposta.json().then(json => {
            console.log(json.id);
            console.log(JSON.stringify(json));

            fkcliente = json.id;
            console.log(`Esse é o fkcliente ${fkcliente}`)

      fetch("/usuarios/cadastrarMetr", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                nomeSetorServer: NomeSetor,
                temperaturaMaxServer: TempMax,
                temperaturaMinServer: TempMin,
                umidadeMaxServer: UmidadeMax,
                umidadeMinServer: UmidadeMin,
                fkClienteSetorServer: fkcliente


              }),
            })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                  console.log("métricas cadastradas com sucesso")

                  setTimeout(() => {
                    window.location = "login.html";
                  }, "2000");
                  //limparFormulario();
                  //finalizarAguardar();
                } else {
                  throw "Houve um erro ao tentar realizar o cadastro das métricas!";
                }
              })

          });


        } else {

          resposta.text().then(texto => {
            console.error(texto);
          });
        }

      }).catch(function (erro) {
        console.log(erro);
      })


    }

          };

        








  // const é uma forma de declarar váriaveis, é uma constante, a primeira vez que ela é declarada, ela morrre desse jeito
  // const ctx = document.getElementById('umiChart');

  // new Chart(ctx, {
  //   type: 'line',
  //   data: {
  //     labels: ['12h', '12h30', '13h', '13h30', '14h', '14h30', '15h', '15h30', '16h'],
  //     datasets: [{
  //       label: 'Sensor 1',
  //       data: [40, 42, 48, 51, 55, 60, 59, 57, 52],
  //       borderColor: 'rgb(252, 252, 28)',
  //       backgroundColor: 'rgb(252, 252, 28)',
  //       borderWidth: 2
  //     }, {
  //       label: 'Sensor 2',
  //       data: [50, 48, 45, 46, 49, 50, 55, 56, 57],
  //       borderColor: 'rgb(252, 252, 28)',
  //       backgroundColor: 'rgb(252, 252, 28)',
  //       borderWidth: 2
  //     },
  //     {
  //       label: 'Sensor 3',
  //       data: [60, 62, 64, 61, 59, 57, 55, 52, 41],
  //       borderColor: 'green',
  //       backgroundColor: 'green',
  //       borderWidth: 2
  //     }, {
  //       label: 'Sensor 4',
  //       data: [41, 44, 43, 47, 48, 49, 51, 54, 45],
  //       borderColor: 'green',
  //       backgroundColor: 'green',
  //       borderWidth: 2
  //     }

  //     ]
  //   },
  //   options: {
  //     scales: {
  //       y: {
  //         beginAtZero: true
  //       }
  //     }
  //   }
  // })

  // const ctx1 = document.getElementById('tempChart');

  // new Chart(ctx1, {
  //   type: 'line',
  //   data: {
  //     labels: ['12h', '12h30', '13h', '13h30', '14h', '14h30', '15h', '15h30', '16h'],
  //     datasets: [{
  //       label: 'Sensor 1',
  //       data: [40, 42, 48, 51, 55, 60, 59, 57, 52],
  //       borderColor: 'red',
  //       backgroundColor: 'red',
  //       borderWidth: 2
  //     }, {
  //       label: 'Sensor 2',
  //       data: [50, 48, 45, 46, 49, 50, 55, 56, 31],
  //       borderColor: 'orange',
  //       backgroundColor: 'orange',
  //       borderWidth: 2
  //     },
  //     {
  //       label: 'Sensor 3',
  //       data: [60, 62, 64, 61, 59, 57, 55, 52, 41],
  //       borderColor: 'green',
  //       backgroundColor: 'green',
  //       borderWidth: 2
  //     }, {
  //       label: 'Sensor 4',
  //       data: [41, 44, 43, 47, 48, 49, 51, 54, 45],
  //       borderColor: 'green',
  //       backgroundColor: 'green',
  //       borderWidth: 2
  //     }

  //     ]
  //   },
  //   options: {
  //     scales: {
  //       y: {
  //         beginAtZero: true
  //       }
  //     }
  //   }
  // })


</script>

</html>