<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="cadastro.html">
  <link rel="stylesheet" href="css/estilo copy.css" />
  <link rel="stylesheet" href="css/cadastro copy.css">
  <link rel="stylesheet" href="css/global.css">
  <script src="../js/sessao.js"></script>
  <script src="../js/alerta.js"></script>
  <script data-jsd-embedded data-key="c3d0cec5-92ec-4622-abba-6b7e317e1cb2" data-base-url="https://jsd-widget.atlassian.com" src="https://jsd-widget.atlassian.com/assets/embed.js"></script>
</head>

<body onload="exibirSetores(), validarSessao(), montargraficos()">
  <div class="alhinhamento">
    <div class="menu">
      <img src="assets/img/profile.png">
      <strong>Olá, <strong id="b_usuario">usuário</strong> !</strong>
      <ul>
        <li>
          <a href="index.html"><img src="assets/img/silhueta-de-icone-de-casa.png">Home</a>
        </li>
        <li>
          <a href="becold.atlassian.net"><img src="assets/img/suporte-ao-cliente.png">Suporte</a>
        </li>
        <li>
          <a href="index.html"><img src="assets/img/sair.png" onclick="limparSessao()">Sair</a>
        </li>
      </ul>
    </div>
    <div id="cadastrometricas" style="display: none; height: 450px; " class="margin cadastro-container">
      <div class="cadastro-input">
        <div class="input-esquerdo">
          <div>
            <h3>Informe os Parametros:</h3>
            <p>Nome do Setor<span style="color: red;">*</span></p>
            <div id="div_input_nomeSetor" class="div-input">
              <input class="inputs" type="text" id="input_setor">
              <div id="divNomeSetor" style="color: red;"></div>
            </div>
          </div>
          <div>
            <p>Intervalo Ideal da Temperatura</p>
            <div>
              <p>Min:<span style="color: red;">*</span></p>
              <div id="div_input_tempmin">
                <input class="inputs" type="number" id="input_tempMin">
                <div id="div_temperaturaErroMin" style="color: red;"></div>
              </div>
            </div>
            <div>
              <p>Máx:<span style="color: red;">*</span></p>
              <div id="div_input_tempmax">
                <input class="inputs" type="number" id="input_tempMax">
                <div id="div_temperaturaErroMax" style="color: red;"></div>
              </div>
            </div>
            <p>Intervalo Ideal da Umidade<span style="color: red;">*</span></p>
            <div>
              <p>Min:<span style="color: red;">*</span></p>
              <div id="div_input_umidademin">
                <input class="inputs" type="number" id="input_umidMin">
                <div id="div_umidadeErroMin" style="color: red;"></div>
              </div>
            </div>
            <div>
              <p>Máx:<span style="color: red;">*</span></p>
              <div id="div_input_umidademax">
                <input class="inputs" type="number" id="input_umidMax">
                <div id="div_umidadeErroMax" style="color: red;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="div-botao">
        <button class="cadastro-botao" onclick="exibircadastrometricas()">Cadastre</button>
      </div>
    </div>
    <div id="dashboad" class="dashboard">
      <h1>Selecione o setor que deseja visualizar</h1>
      <div class="alinhamento-custom">
        <select id="slct_setor" onclick="setores(), graficonovo()">
        </select>
        <button onclick="exibircadastrometricas()"><img style="padding: 0px;" src="assets/img/more.png"></button>
      </div>
      <div class="linha-alhinhamento">
        <div class="KPI">
          <h5>Umidade mais alta registrada na última hora</h5>
          <h3 id="umialta"><img src="assets/img/umidade.png"></h3>
        </div>
        <div class="KPI">
          <h5>Umidade mais baixa registrada na última hora</h5>
          <h3 id="umibaixa"><img src="assets/img/umidade.png"></h3>
        </div>
        <div class="KPI">
          <h5>Temperatura mais alta registrada na última hora</h5>
          <h3 id="tempalta"><img src="assets/img/temperatura.png"></h3>
        </div>
        <div class="KPI">
          <h5>Temperatura mais baixa registrada na última hora</h5>
          <h3 id="tempbaixa"><img src="assets/img/temperatura.png"></h3>
        </div>
      </div>
      <div class="linha-alhinhamento">
        <div class="card-metrica">
          <h2>Métricas Ideais</h2>
          <div class="card-background">
            <div style="background-color: #012569; border: 2px solid black;" class="metrica">
              <span>Critico</span><span>20% - 24%</span><span>5ºC -
                14ºC</span></div>
            <div style="background-color: #012569; border: 2px solid black;" class="metrica">
              <span>Emergência</span><span>25% -
                29%</span><span>15ºC - 16ºC</span></div>
            <div style="background-color: #012569; border: 2px solid black;" class="metrica">
              <span>Alerta</span><span>30% - 39%
              </span><span>17ºC - 19ºC</span></div>
            <div style="background-color: #012569; border: 2px solid black;" class="metrica"><span>Ideal</span><span>40%
                - 55%</span><span>20ºC -
                27ºC</span></div>
            <div style="background-color: #012569; border: 2px solid black;" class="metrica">
              <span>Alerta</span><span>56% -
                65%</span><span>28ºC - 30ºC</span></div>
            <div style="background-color: #012569; border: 2px solid black;" class="metrica">
              <span>Emergência</span><span>66% -
                75%</span><span>31ºC - 35ºC</span></div>
            <div style="background-color:#012569; border: 2px solid black;" class="metrica">
              <span>Critico</span><span>76% - 80%</span><span>36ºC -
                50ºC</span></div>
          </div>
        </div>
      </div>
      <div class="linha-alhinhamento">
        <div class="card-grafico">
          <h2>Umidade</h2>
          <canvas id="umiChart" style="position: relative;height:40vh;"></canvas>
        </div>
        <div class="card-grafico">
          <h2>Temperatura</h2>
          <canvas id="tempChart" style="position: relative;  height: 40vh;"></canvas>
        </div>
      </div>
</body>

<script>
  b_usuario.innerHTML = sessionStorage.EMPRESA_USUARIO

  var cliente = sessionStorage.ID_USUARIO

  var limitessetor = {}


  async function setores() {



    var setor_escolhido = slct_setor.value

    const limites = await fetch(`/setores/limite/${setor_escolhido}`, { cache: 'no-store' });

    var lim = await limites.json()

    limitessetor.tempmax = lim[0].temperaturamax
    limitessetor.tempmin = lim[0].temperaturamin
    limitessetor.umimax = lim[0].umidademax
    limitessetor.umimin = lim[0].umidademin


    const max = await fetch("/medidas/maxtemp", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        idSetor: setor_escolhido

      })
    });

    var kpi1 = (await max.json())[0]



    document.getElementById("tempalta").innerHTML = `Sensor ${kpi1.nomesensor} - ${kpi1.maior_temp}ºC`


    const min = await fetch("/medidas/mintemp", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        idSetor: setor_escolhido

      })
    });

    var kpi2 = (await min.json())[0]



    document.getElementById("tempbaixa").innerHTML = `Sensor ${kpi2.nomesensor} - ${kpi2.menor_temp}ºC`

    const min2 = await fetch("/medidas/minumi", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        idSetor: setor_escolhido

      })
    });

    var kpi3 = (await min2.json())[0]



    document.getElementById("umibaixa").innerHTML = `Sensor ${kpi3.nomesensor} - ${kpi3.menor_umi} %`

    const max2 = await fetch("/medidas/maxumi", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        idSetor: setor_escolhido

      })
    });

    var kpi4 = (await max2.json())[0]



    document.getElementById("umialta").innerHTML = `Sensor ${kpi4.nomesensor} - ${kpi4.maior_umi} %`



  }


  function exibirSetores() {
    JSON.parse(sessionStorage.SETORES).forEach(item => {
      document.getElementById("slct_setor").innerHTML += `
            <option value="${item.idSetor}">${item.nomeSetor}</option>
            `


    });


    setores()
  }

  let ctx

  let ctx1
  let horarios = []

  function graficonovo() {
    ctx.destroy()
    ctx1.destroy()

    horarios.length = 0
    //console.log(horarios)

    montargraficos()

  }


  function exibircadastrometricas() {


    dashboad.style.display = "none"
    cadastrometricas.style.display = "block"



    var empresa = sessionStorage.EMPRESA_USUARIO;
    var cnpj = sessionStorage.CNPJ_USUARIO;
    var email = sessionStorage.EMAIL_USUARIO;
    var NomeSetor = input_setor.value;
    var TempMin = Number(input_tempMin.value);
    var TempMax = Number(input_tempMax.value);
    var UmidadeMin = Number(input_umidMin.value);
    var UmidadeMax = Number(input_umidMax.value);

    if (NomeSetor == "" || TempMin == "" || TempMax == "" || UmidadeMin == "" || UmidadeMax == "" || TempMin >= TempMax | UmidadeMin >= UmidadeMax) {
      div_umidadeErroMax.innerHTML = `Cheque todas as entradas`;
    } else {

      fetch("/usuarios/buscarfk", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          empresaServer: empresa,
          cnpjServer: cnpj,
          emailServer: email,


        })
      }).then(function (resposta) {
        console.log("ESTOU NO THEN DO entrar()!")

        if (resposta.ok) {
          //console.log(resposta);

          resposta.json().then(json => {
            //console.log(json.id);
            //console.log(JSON.stringify(json));

            fkcliente = json.id;
            //console.log(`Esse é o fkcliente ${fkcliente}`)

            fetch("/usuarios/cadastrarMetr", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                nomeSetorServer: NomeSetor,
                temperaturaMaxServer: TempMax,
                temperaturaMinServer: TempMin,
                umidadeMaxServer: UmidadeMax,
                umidadeMinServer: UmidadeMin,
                fkClienteSetorServer: fkcliente


              }),
            })
              .then(function (resposta) {
                //console.log("resposta: ", resposta);

                if (resposta.ok) {
                  //console.log("métricas cadastradas com sucesso")

                  setTimeout(() => {
                    window.location = "login.html";
                  }, "2000");
                  //limparFormulario();
                  //finalizarAguardar();
                } else {
                  throw "Houve um erro ao tentar realizar o cadastro das métricas!";
                }
              })

          });


        } else {

          resposta.text().then(texto => {
            console.error(texto);
          });
        }

      }).catch(function (erro) {
        console.log(erro);
      })


    }

  };


  // const é uma forma de declarar váriaveis, é uma constante, a primeira vez que ela é declarada, ela morrre desse jeito


  async function montargraficos() {

    var setor_escolhido = slct_setor.value

    let dadosTemp = {
      labels: ['', '', '', '', '', '', '', '', '', '', ''],
      datasets: []
    };

    let dadosUmi = {
      labels: ['', '', '', '', '', '', '', '', '', '', ''],
      datasets: []
    };

    const configTemp = { type: 'line', data: dadosTemp }

    const configUmi = { type: 'line', data: dadosUmi }



    const sensor = await fetch(`/setores/sensores/${setor_escolhido}`, { cache: 'no-store' });

    var sen = await sensor.json()

    //console.log(sen)

    for (var i = 0; i < sen.length; i++) {

      var r = (Math.random() * 255).toFixed(0)
      var g = (Math.random() * 255).toFixed(0)
      var b = (Math.random() * 255).toFixed(0)

      dadosTemp.datasets.push({
        label: `${sen[i].nomeSensor}`,
        data: [],
        fill: false,
        borderColor: `rgb(${r}, ${g}, ${b})`,
        backgroundColor: `rgb(${r}, ${g}, ${b})`,
        borderWidth: 2,
        tension: 0.1
      })

      dadosUmi.datasets.push({
        label: `${sen[i].nomeSensor}`,
        data: [],
        fill: false,
        borderColor: `rgb(${r}, ${g}, ${b})`,
        backgroundColor: `rgb(${r}, ${g}, ${b})`,
        borderWidth: 2,
        tension: 0.1
      })

      // buscando dados de temperatura e umidade para cada sensor 
      const temp = await fetch(`/setores/temp/${sen[i].idSensor}`, { cache: 'no-store' });
      var temperature = await temp.json()

      const umi = await fetch(`/setores/umi/${sen[i].idSensor}`, { cache: 'no-store' });
      var humidity = await umi.json()
      //console.log(temperature)

      for (var t = 0; t < temperature.length; t++) {

        dadosTemp.datasets[i].data.push(temperature[t].temperatura)


        if (t == temperature.length - 1) {
          horarios.push({ [`Sensor${sen[i].idSensor}`]: temperature[t].hora })
        }
      }


      for (var u = 0; u < humidity.length; u++) {
        dadosUmi.datasets[i].data.push(humidity[u].umidade)
      }

    }

    //console.log(horarios)

    ctx = new Chart(document.getElementById('tempChart'), configTemp)

    ctx1 = new Chart(document.getElementById('umiChart'), configUmi)

    setInterval(() => atualizar(dadosTemp, dadosUmi, ctx, ctx1), 2000)
    //setTimeout(() => atualizar(setor_escolhido, dadosTemp, dadosUmi), 2000)
  }


  async function atualizar(dados1, dados2, chart1, chart2) {
    let idSetor = slct_setor.value
    const sensor = await fetch(`/setores/sensores/${idSetor}`, { cache: 'no-store' });

    var sen = await sensor.json()

    //console.log('idSetor', idSetor)



    for (var h = 0; h < sen.length; h++) {

      const update = await fetch(`/setores/update/${sen[h].idSensor}`, { cache: 'no-store' });

      var up = await update.json()


      //console.log(`sen[${h}].idSensor`,sen[h].idSensor)
      if (up[0].hora == horarios[h][`Sensor${sen[h].idSensor}`]) {
        console.log('Valor Atualizado')
      }
      else {
        if (up[0].temperatura > limitessetor.tempmax || up[0].temperatura < limitessetor.tempmin || up[0].umidade > limitessetor.umimax || up[0].umidade < limitessetor.umimin) {
          alert(`O sensor ${sen[h].nomeSensor} está fora dos valores limites estabelecidos de umidade e/ou temperatura`)
        }
      }

      horarios[h][`Sensor${sen[h].idSensor}`] = up[0].hora

        dados1.datasets[h].data.shift()
        dados1.datasets[h].data.push(up[0].temperatura)
        dados2.datasets[h].data.shift()
        dados2.datasets[h].data.push(up[0].umidade)

        console.log(dados1.datasets[h].data, dados2.datasets[h].data)

        chart1.update()
        chart2.update()


    }



  }



</script>

</html>